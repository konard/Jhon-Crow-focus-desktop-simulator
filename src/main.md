# main.js - Документация главного процесса Electron

## Что это за файл?

`main.js` - это "мозг" приложения. Он запускается первым при старте программы и отвечает за:
- Создание окна приложения
- Работу с файлами на вашем компьютере
- Обработку аудио (запись, воспроизведение музыки)
- Сохранение настроек приложения

**Важно:** Этот файл работает в "главном процессе" Electron, который имеет полный доступ к вашей операционной системе (файлам, папкам, запуску программ).

## Структура файла

### 1. Подключение библиотек (строки 1-5)

```javascript
const { app, BrowserWindow, ipcMain, dialog } = require('electron');
const path = require('path');
const { exec, spawn } = require('child_process');
const fs = require('fs');
const os = require('os');
```

**Что это значит:**
- `electron` - главная библиотека для создания десктопных приложений
- `path` - помогает работать с путями к файлам
- `child_process` - позволяет запускать другие программы (например, FFmpeg)
- `fs` - работа с файлами (чтение, запись, удаление)
- `os` - получение информации об операционной системе

### 2. Создание окна приложения

#### Функция `createWindow()` (строки 10-49)

**Что она делает:**
Создаёт главное окно приложения с настройками размера, безопасности и внешнего вида.

**Ключевые параметры:**
- `width`, `height` - размер окна (берётся размер экрана)
- `minWidth: 800, minHeight: 600` - минимальный размер окна
- `nodeIntegration: false` - **КРИТИЧЕСКИ ВАЖНО!** Отключает Node.js в веб-странице для безопасности
- `contextIsolation: true` - **КРИТИЧЕСКИ ВАЖНО!** Изолирует код страницы от системного кода
- `preload: path.join(__dirname, 'preload.js')` - подключает безопасный мост между страницей и системой
- `show: false` - окно не показывается сразу (избегаем "мигания" при загрузке)

**Почему настройки безопасности важны:**
Без `nodeIntegration: false` и `contextIsolation: true` злоумышленник мог бы через веб-страницу получить доступ к вашим файлам!

### 3. Работа с FFmpeg

FFmpeg - это программа для обработки аудио и видео. Приложение использует её для:
- Конвертации аудиофайлов в нужный формат
- Сохранения записей с диктофона

#### Функция `checkFfmpegAvailable()` (строки 219-241)

**Что она делает:**
Проверяет, установлена ли программа FFmpeg на компьютере.

**Как работает:**
1. Пытается запустить команду `ffmpeg -version`
2. Если команда выполнилась успешно (код 0) - FFmpeg установлен
3. Если ошибка - FFmpeg не найден

#### Функция `tryInstallFfmpeg()` (строки 56-96)

**Что она делает:**
Пытается автоматически установить FFmpeg в зависимости от операционной системы.

**Поддерживаемые системы:**
- Windows: использует `winget` (требует прав администратора)
- macOS: использует `brew`
- Linux: использует `apt-get` (для Debian/Ubuntu)

**КРИТИЧЕСКИ ВАЖНО:** Автоматическая установка может не сработать, если нет прав администратора!

### 4. Сохранение и загрузка состояния

#### IPC Handler `save-state` (строки 141-151)

**Что это:**
IPC (Inter-Process Communication) - способ общения между главным процессом и веб-страницей.

**Что делает:**
Сохраняет расположение объектов на столе в файл `desk-state.json`.

**Где хранится:**
В папке `userData` приложения (обычно `C:\Users\ИМЯ\AppData\Roaming\Focus Desktop Simulator`).

**Формат данных:**
JSON - текстовый формат для хранения данных в виде `{"ключ": "значение"}`.

#### IPC Handler `load-state` (строки 153-166)

**Что делает:**
Загружает сохранённое состояние стола при запуске приложения.

**Как работает:**
1. Проверяет, существует ли файл `desk-state.json`
2. Если да - читает его и отправляет данные на страницу
3. Если нет - возвращает `null` (пустое состояние)

### 5. Работа с большими данными

#### IPC Handler `save-object-data` (строки 169-193)

**Зачем это нужно:**
Большие файлы (PDF, обложки музыки) сохраняются отдельно, чтобы не замедлять сохранение позиций объектов.

**КРИТИЧЕСКИ ВАЖНО:** Эта оптимизация решает проблему зависания при перемещении объектов (см. закрытые issues)!

**Где хранятся данные:**
В папке `userData/object-data/` с именами вида `{objectId}-{dataType}.data`.

### 6. Транскодирование аудио

#### Функция `transcodeToWavWithFfmpeg()` (строки 251-288)

**Что делает:**
Конвертирует любой аудиофайл в формат WAV (16-bit PCM, моно, 44100 Hz).

**Зачем это нужно:**
Браузер не может воспроизводить некоторые форматы аудио (WMA, APE, FLAC с нестандартными настройками).

**Параметры FFmpeg:**
- `-i inputPath` - входной файл
- `-t 10` - ограничение длительности 10 секундами (для экономии памяти)
- `-acodec pcm_s16le` - кодек 16-bit PCM (универсальный формат)
- `-ar 44100` - частота дискретизации 44.1 кГц (стандарт CD)
- `-ac 1` - моно (уменьшает размер файла)
- `-y` - перезаписывать выходной файл без вопросов

### 7. Музыкальный плеер (Cassette Player)

#### Функция `findAudioFilesRecursively()` (строки 358-395)

**Что делает:**
Рекурсивно сканирует папку и все подпапки, находя все аудиофайлы.

**Рекурсия - что это:**
Функция вызывает сама себя для обработки вложенных папок. Как матрёшка - открываем одну, внутри ещё одна, и так далее.

**Поддерживаемые форматы:**
`.mp3`, `.wav`, `.ogg`, `.flac`, `.aac`, `.m4a`, `.webm`, `.opus`

**КРИТИЧЕСКИ ВАЖНО:** При изменении папки с музыкой во время воспроизведения должно начинаться воспроизведение первого файла в новой папке (см. issue #66)!

#### IPC Handler `select-music-folder` (строки 398-424)

**Что делает:**
1. Открывает диалог выбора папки
2. Сканирует выбранную папку на наличие аудиофайлов
3. Сортирует файлы по алфавиту
4. Возвращает список файлов на страницу

### 8. Диктофон (Dictaphone)

#### IPC Handler `save-recording` (строки 608-844)

**Что делает:**
Сохраняет запись с микрофона в выбранную папку.

**Поддерживаемые форматы:**
- WebM (по умолчанию, не требует FFmpeg)
- WAV (требует FFmpeg для конвертации)
- MP3 (требует FFmpeg для конвертации)

**Логика работы:**
1. Если выбран формат WebM - сохраняем напрямую (быстро)
2. Если выбран WAV/MP3 и FFmpeg установлен - конвертируем через FFmpeg
3. Если FFmpeg не установлен - сохраняем как WebM с предупреждением

**КРИТИЧЕСКИ ВАЖНО:** Функция всегда сохранит запись, даже если FFmpeg не установлен! Это предотвращает потерю данных.

### 9. Markdown редактор

#### IPC Handler `get-default-notes-folder` (строки 881-891)

**Что делает:**
Создаёт и возвращает путь к папке для заметок по умолчанию.

**Где находится:**
`userData/notes/` (например, `C:\Users\ИМЯ\AppData\Roaming\Focus Desktop Simulator\notes\`)

#### IPC Handler `save-markdown-file` (строки 918-941)

**Что делает:**
Сохраняет текст заметки в .md файл (Markdown формат).

**Безопасность:**
Автоматически добавляет расширение `.md`, если его нет - предотвращает сохранение файлов без расширения.

## Критически важные моменты (из закрытых issues)

### 1. Коллизии объектов (issue #39, #30, #66)
- У некоторых объектов не должно быть коллизии стека (круглые часы, Photo Frame)
- У ноутбука должны быть несколько высоких коллизий по длине монитора
- Большой плеер должен иметь правильные коллизии для укладки ноутбука сверху

### 2. Воспроизведение музыки (issue #66)
- При смене папки с музыкой во время воспроизведения должен начинаться первый файл в новой папке
- Текущий файл должен останавливаться

### 3. Производительность (issue #20, #25)
- Большие данные (PDF, обложки) сохраняются отдельно через `save-object-data`
- Позиции объектов сохраняются через `save-state` с debounce (задержкой)
- Это предотвращает зависания при перемещении объектов

### 4. FFmpeg
- Приложение работает без FFmpeg, но с ограниченной функциональностью
- Автоматическая установка может не сработать - пользователь должен знать, что можно установить вручную
- Всегда есть fallback (запасной вариант) - сохранение в WebM формате

## Как внести изменения

### Добавить новый формат аудио

1. Найдите константу `AUDIO_EXTENSIONS` (строка 355)
2. Добавьте расширение в массив: `'.новый_формат'`
3. Добавьте MIME-тип в объект `mimeTypes` (строка 438)

### Изменить путь сохранения данных

1. Найдите вызовы `app.getPath('userData')` (строки 142, 171, 883)
2. Измените путь с помощью `path.join()`

### Добавить новый IPC handler

```javascript
ipcMain.handle('имя-команды', async (event, параметры) => {
  try {
    // Ваш код здесь
    return { success: true, data: результат };
  } catch (error) {
    return { success: false, error: error.message };
  }
});
```

**ВАЖНО:** Всегда оборачивайте в try-catch и возвращайте объект с полем `success`!

## Связанные файлы

- [preload.js](preload.md) - мост между main.js и renderer.js
- [renderer.js](renderer.md) - код веб-страницы, использующий IPC handlers
- [package.json](../package.md) - настройки приложения и зависимости
